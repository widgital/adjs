<!DOCTYPE html>

<html>
<head>
  <title>slot.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="slot.html">
                slot.coffee
              </a>
            
              
              <a class="source" href="ad_request.html">
                ad_request.coffee
              </a>
            
              
              <a class="source" href="advertiser.html">
                advertiser.coffee
              </a>
            
              
              <a class="source" href="base.html">
                base.coffee
              </a>
            
              
              <a class="source" href="config.html">
                config.coffee
              </a>
            
              
              <a class="source" href="endpoint.html">
                endpoint.coffee
              </a>
            
              
              <a class="source" href="engagement.html">
                engagement.coffee
              </a>
            
              
              <a class="source" href="event.html">
                event.coffee
              </a>
            
              
              <a class="source" href="page.html">
                page.coffee
              </a>
            
              
              <a class="source" href="sizes.html">
                sizes.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>slot.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><a href="./sizes.html">Sizes</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>sizes = <span class="hljs-built_in">require</span> <span class="hljs-string">'../shared/sizes'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><a href="./utils.html">Utils</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>utils = <span class="hljs-built_in">require</span> <span class="hljs-string">'../shared/utils'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><a href="./event.html">Events</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../shared/event'</span>)([<span class="hljs-string">"request"</span>,<span class="hljs-string">"click"</span>,<span class="hljs-string">"load"</span>,<span class="hljs-string">"view"</span>,
                                    <span class="hljs-string">"unload"</span>,<span class="hljs-string">"focus"</span>,<span class="hljs-string">"engage"</span>,
                                    <span class="hljs-string">"unfocus"</span>,<span class="hljs-string">"expand"</span>,<span class="hljs-string">"collapse"</span>,<span class="hljs-string">"refreshed"</span>,
                                    <span class="hljs-string">"cookie"</span>,<span class="hljs-string">"receive"</span>,<span class="hljs-string">"unview"</span>,<span class="hljs-string">"timeout"</span>])


<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">($sf)</span>-&gt;</span>
  sfDom = $sf.lib.dom</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create the collection of slots</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  slots = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>regex to find the content of a tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  SCRIPT_REGEX = <span class="hljs-regexp">/&lt;!--([\s\S]*)--&gt;/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Publisher Slot class, this represents the slot on the page. This can be accessed by the publisher
It remains in memory until its destroyed. It can be accessed via Slot(“name”) which will persist it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Slot</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>create the slot is the same as Slot(adId)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">constructor</span>:<span class="hljs-function"><span class="hljs-params">(adId)</span>-&gt;</span>
      <span class="hljs-keyword">if</span> @ <span class="hljs-keyword">instanceof</span> Slot
        <span class="hljs-keyword">return</span> <span class="hljs-property">@init</span>(adId)
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Slot(adId)
    <span class="hljs-attribute">init</span>:<span class="hljs-function"><span class="hljs-params">(adId)</span>-&gt;</span>
      <span class="hljs-keyword">if</span> slots[adId]
        <span class="hljs-keyword">return</span>  slots[adId]
      <span class="hljs-property">@id</span>= adId</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>every time the ad is refreshed the count goes up for the slot</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@count</span> = <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>we then add the Slot object to our persisted collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      slots[adId] = @
      <span class="hljs-property">@initEvents</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="autorefresh">Autorefresh</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>If the div to build the ad slot has data-refresh-time=<time_value>
These functions are used to start them. A timeout is set and reset after every refreshed ad is loaded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-attribute">startAutoRefresh</span>:<span class="hljs-function"><span class="hljs-params">(delay=<span class="hljs-number">60</span>,cb)</span>-&gt;</span>
      <span class="hljs-keyword">unless</span> <span class="hljs-property">@_isAutoRefreshing</span>
        <span class="hljs-property">@_isAutoRefreshing</span> =<span class="hljs-literal">true</span>
        <span class="hljs-property">@_refreshInterval</span> = setTimeout(<span class="hljs-function">=&gt;</span>
          <span class="hljs-property">@_isAutoRefreshing</span> = <span class="hljs-literal">false</span>
          <span class="hljs-keyword">if</span> <span class="hljs-property">@loadTime</span>
            <span class="hljs-property">@refresh</span>(cb)
        ,delay*<span class="hljs-number">1000</span>)
      @
    <span class="hljs-attribute">stopAutoRefresh</span>:<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
      clearTimeout(<span class="hljs-property">@_refreshInterval</span>)
      <span class="hljs-property">@_isAutoRefreshing</span>= <span class="hljs-literal">false</span>
      <span class="hljs-property">@_refreshInterval</span> = <span class="hljs-literal">null</span>
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>refresh the ad and increase the count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">refresh</span>:<span class="hljs-function"><span class="hljs-params">(cb)</span>-&gt;</span>
      <span class="hljs-property">@remove</span>()
      <span class="hljs-property">@count</span>++
      <span class="hljs-property">@posMeta</span>.setValue(<span class="hljs-string">"load_n"</span>,<span class="hljs-string">"extended"</span>,<span class="hljs-property">@count</span>)
      $sf.host.render(<span class="hljs-property">@pos</span>)
      <span class="hljs-property">@frame</span> = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-property">@posConfig</span>.dest)
      cb?(@)
      <span class="hljs-property">@refreshed</span>()
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>override the events trigger to trigger events and allow ‘dumb’ slots to not do anything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">trigger</span>:<span class="hljs-function"><span class="hljs-params">(event)</span>=&gt;</span>
      <span class="hljs-keyword">unless</span> <span class="hljs-property">@options</span>?.ignoreEvents
        events.trigger.apply @,arguments</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>call the global trigger</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Slot.trigger event,@,arguments[<span class="hljs-number">1</span>]
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>this gets called when a message is received from a safeframe
object is mutated and/or events are fired as necessary based on the message sent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">handleMessage</span>:<span class="hljs-function"><span class="hljs-params">(msg,content)</span>-&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span> msg
        <span class="hljs-keyword">when</span> <span class="hljs-string">"focus-change"</span>
          <span class="hljs-keyword">if</span> content <span class="hljs-keyword">then</span> <span class="hljs-property">@focus</span>() <span class="hljs-keyword">else</span> <span class="hljs-property">@unfocus</span>()
        <span class="hljs-keyword">when</span> <span class="hljs-string">"geom-update"</span> <span class="hljs-keyword">then</span><span class="hljs-function"> -&gt;</span>
        <span class="hljs-keyword">when</span> <span class="hljs-string">"expand"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@expand</span>(content)
        <span class="hljs-keyword">when</span> <span class="hljs-string">"collapse"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@collapse</span>(content)
        <span class="hljs-keyword">when</span> <span class="hljs-string">"viewed"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@view</span>() <span class="hljs-keyword">unless</span> <span class="hljs-property">@viewed</span>
        <span class="hljs-keyword">when</span> <span class="hljs-string">"unviewed"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@unview</span>() <span class="hljs-keyword">unless</span> <span class="hljs-property">@unviewed</span> &amp;&amp; <span class="hljs-property">@viewed</span>
        <span class="hljs-keyword">when</span> <span class="hljs-string">"clicked"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@click</span>() <span class="hljs-keyword">unless</span> <span class="hljs-property">@clicked</span>
        <span class="hljs-keyword">when</span> <span class="hljs-string">"requested"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@request</span>()
        <span class="hljs-keyword">when</span> <span class="hljs-string">"cookie-write"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@cookie</span>(<span class="hljs-attribute">cookie</span>:<span class="hljs-string">"write"</span>,<span class="hljs-attribute">content</span>: content)
        <span class="hljs-keyword">when</span> <span class="hljs-string">"cookie-read"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@cookie</span>(<span class="hljs-attribute">cookie</span>:<span class="hljs-string">"read"</span>,<span class="hljs-attribute">content</span>:content)
        <span class="hljs-keyword">when</span> <span class="hljs-string">"reload"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@reload</span>()
        <span class="hljs-keyword">when</span> <span class="hljs-string">"msg"</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@receive</span>(decodeURIComponent(content))
        <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="-events"> Events</h2>
<p> Slots are event driven. We have a number of events that are standardised that can be used on a slot:</p>
<table>
<thead>
<tr>
<th>event name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td> request</td>
<td>occurs when the ad is requested</td>
</tr>
<tr>
<td> click</td>
<td>occurs when the ad is clicked</td>
</tr>
<tr>
<td> load</td>
<td>occurs when the ad has been loaded</td>
</tr>
<tr>
<td> view</td>
<td>Occurs when greater than 50% of the ad is in view for greater than 1 second</td>
</tr>
<tr>
<td> unload</td>
<td>Occurs when the ad is removed</td>
</tr>
<tr>
<td> focus</td>
<td>occurs when the ad has gained focus</td>
</tr>
<tr>
<td> unfocus</td>
<td>occurs when the ad loses focus</td>
</tr>
<tr>
<td> engage</td>
<td>occurs when there is engagement and the view event has already fired</td>
</tr>
<tr>
<td> expand</td>
<td>occurs when the ad has expanded</td>
</tr>
<tr>
<td> collapse</td>
<td>occurs when the ad has collapsed</td>
</tr>
<tr>
<td> refreshed</td>
<td>occurs when the ad has refreshed</td>
</tr>
<tr>
<td> cookie</td>
<td>occurs when the ad sets a cookie</td>
</tr>
<tr>
<td> receive</td>
<td>enables the advertiser to send custom messages to the publisher this is called with the message body</td>
</tr>
<tr>
<td> unview</td>
<td>occurs when a viewed ad leaves view</td>
</tr>
<tr>
<td> timeout</td>
<td>occurs when the slot timeouts loading an ad</td>
</tr>
</tbody>
</table>
<p> initEvents initializes the internal ads for state changes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-attribute">initEvents</span>:<span class="hljs-function">-&gt;</span>
      <span class="hljs-property">@request</span><span class="hljs-function"> -&gt;</span>
        <span class="hljs-property">@requestTime</span> = utils.now()
      <span class="hljs-property">@load</span><span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>figure out the load chain, i.e. how many different ad providers deep are in this one slot</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@loadChain</span> = utils.countFrames(<span class="hljs-property">@frame</span>.contentWindow)
        <span class="hljs-property">@loadTime</span> = utils.now()
      <span class="hljs-property">@view</span><span class="hljs-function"> -&gt;</span>
        <span class="hljs-property">@viewed</span> = <span class="hljs-literal">true</span>
        <span class="hljs-property">@viewTime</span> = utils.now()
      <span class="hljs-property">@engage</span><span class="hljs-function"> -&gt;</span>
        <span class="hljs-keyword">unless</span> <span class="hljs-property">@engaged</span>
          <span class="hljs-property">@engaged</span> = <span class="hljs-literal">true</span>
          <span class="hljs-property">@engageTime</span> = utils.now()
          <span class="hljs-property">@notifyFrame</span>(<span class="hljs-string">"engaged"</span>)
      <span class="hljs-property">@unview</span><span class="hljs-function"> -&gt;</span>
        <span class="hljs-property">@unviewed</span> = <span class="hljs-literal">true</span>
        <span class="hljs-property">@unviewTime</span> = utils.now()
      <span class="hljs-property">@unload</span><span class="hljs-function"> -&gt;</span>
        <span class="hljs-property">@unloadTime</span> = utils.now()
      <span class="hljs-property">@click</span><span class="hljs-function"> -&gt;</span>
        <span class="hljs-property">@clicked</span> = <span class="hljs-literal">true</span>
    <span class="hljs-attribute">loadChain</span>: <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>from the slot you can send a message to the safeframe</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">notifyFrame</span>:<span class="hljs-function"><span class="hljs-params">(cmd,data)</span>-&gt;</span>
      msgObj = $sf.lib.lang.ParamHash()
      <span class="hljs-keyword">if</span> <span class="hljs-property">@posConfig</span>
        msgObj.pos = <span class="hljs-property">@posConfig</span>.id
        msgObj.cmd = cmd
        msgObj.value = escape(data)
        sfDom.msghost.send(<span class="hljs-property">@posConfig</span>.dest,msgObj.toString())</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>create generates the safeframe and ties it to the slot.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">create</span>: <span class="hljs-function"><span class="hljs-params">(elem,html,<span class="hljs-property">@options</span>={})</span>-&gt;</span>
      width = <span class="hljs-property">@options</span>.width <span class="hljs-keyword">or</span> elem.offsetWidth
      height = <span class="hljs-property">@options</span>.height <span class="hljs-keyword">or</span> elem.offsetHeight
      supports = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>this ties into defaults for safeframe in this case
the valid supports are ‘read-cookie’,’write-cookie’,’exp-push’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-property">@options</span>.supports <span class="hljs-keyword">or</span> []
        supports[s] = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>valid disables are ‘exp-ovr</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-property">@options</span>.disables <span class="hljs-keyword">or</span> []
        supports[s] = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>don’t recreate the safeframe</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@elem</span>
      <span class="hljs-property">@elem</span> = elem
      elem.id <span class="hljs-keyword">or</span>=  $sf.lib.lang.guid <span class="hljs-string">"pos"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>generate safeframe metadata</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@posMeta</span> = <span class="hljs-keyword">new</span> $sf.host.PosMeta <span class="hljs-literal">null</span>,<span class="hljs-string">"extended"</span>,
        <span class="hljs-attribute">inview</span>: <span class="hljs-property">@options</span>.inview
        <span class="hljs-attribute">page</span>: <span class="hljs-property">@options</span>.page
        <span class="hljs-attribute">host</span>: <span class="hljs-built_in">document</span>.location.hostname
        <span class="hljs-attribute">referrer</span>: <span class="hljs-property">@options</span>.referrer
        <span class="hljs-attribute">location</span>: <span class="hljs-built_in">document</span>.location.href
        <span class="hljs-attribute">slot_id</span>: <span class="hljs-property">@id</span>
        <span class="hljs-attribute">load_n</span>: <span class="hljs-property">@count</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>generate safeframe posish data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@posConfig</span> = <span class="hljs-keyword">new</span> $sf.host.PosConfig
        <span class="hljs-attribute">id</span>: <span class="hljs-property">@id</span>
        <span class="hljs-attribute">dest</span>:	elem.id
        <span class="hljs-attribute">w</span>:  width
        <span class="hljs-attribute">h</span>:	height
        <span class="hljs-attribute">supports</span>: supports
        <span class="hljs-attribute">renderFile</span>: <span class="hljs-property">@options</span>.renderFile
      <span class="hljs-property">@pos</span>	= <span class="hljs-keyword">new</span> $sf.host.Position(<span class="hljs-property">@posConfig</span>.id, html, <span class="hljs-property">@posMeta</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>attach out of view event if its an option</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.refresh_oov
        <span class="hljs-property">@unview</span><span class="hljs-function"> -&gt;</span>
          setTimeout(<span class="hljs-function">
            =&gt;</span><span class="hljs-property">@refresh</span>()
          ,<span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>attach autorefresh event if its an option after load</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.refresh_time?
        <span class="hljs-property">@refreshTime</span> = $sf.lib.lang.cnum(<span class="hljs-property">@options</span>.refresh_time,<span class="hljs-number">0</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-property">@refreshTime</span>&gt;<span class="hljs-number">0</span>
          <span class="hljs-property">@load</span><span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@startAutoRefresh</span>(<span class="hljs-property">@refreshTime</span>)
          <span class="hljs-property">@timeout</span><span class="hljs-function"> -&gt;</span>
            <span class="hljs-property">@stopAutoRefresh</span>()
            <span class="hljs-property">@refresh</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>render the safeframe!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      $sf.host.render(<span class="hljs-property">@pos</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>get a reference to the frame object, this is useful to find out the total ad depth</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@frame</span> = <span class="hljs-built_in">document</span>.getElementById(elem.id)
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>remove the ad slot - don’t fire is for only load when in view
this is in use essentially to allow doc.write in the frame itself.
the actual solution involves nesting a second iframe inside the safeframe to properly enable this functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">remove</span>:<span class="hljs-function"><span class="hljs-params">(dontFire)</span>-&gt;</span>
      <span class="hljs-property">@unload</span>() <span class="hljs-keyword">unless</span> dontFire
      clearTimeout(<span class="hljs-property">@_refreshInterval</span>)
      <span class="hljs-property">@viewed</span> = <span class="hljs-literal">false</span>
      <span class="hljs-property">@engaged</span> = <span class="hljs-literal">false</span>
      <span class="hljs-property">@unviewed</span> = <span class="hljs-literal">false</span>
      <span class="hljs-property">@frame</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@frameCount</span> = <span class="hljs-number">0</span>
      <span class="hljs-property">@requestTime</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@loadTime</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@viewTime</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@engageTime</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@unviewTime</span> = <span class="hljs-literal">null</span>
      <span class="hljs-property">@unloadTime</span> = <span class="hljs-literal">null</span>
      $sf.host.nuke(<span class="hljs-property">@id</span>)
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>destroy the add and remove all traces of it from memory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">destroy</span>:<span class="hljs-function">-&gt;</span>
      <span class="hljs-property">@stopAutoRefresh</span>()
      <span class="hljs-property">@remove</span>()
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.events
      <span class="hljs-keyword">delete</span> slots[<span class="hljs-property">@id</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>this is a poorly named function for loading the ad when the slot is inview</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">reload</span>:<span class="hljs-function">-&gt;</span>
      <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.inview
        <span class="hljs-property">@remove</span>(<span class="hljs-literal">true</span>)
        $sf.host.render(<span class="hljs-property">@pos</span>)
        <span class="hljs-property">@frame</span> = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-property">@posConfig</span>.dest)</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>when the ad fits our definition of inview:
greater than 50% of the ad is in view for greater than 1 second</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">currentlyInview</span>:<span class="hljs-function">-&gt;</span>
      $sf.host.inViewPercentage(<span class="hljs-property">@id</span>) &gt; <span class="hljs-number">50</span> &amp;&amp; <span class="hljs-property">@viewed</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>the current percentage of an ad that is in view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">inviewPercentage</span>:<span class="hljs-function">-&gt;</span>
      $sf.host.inViewPercentage(<span class="hljs-property">@id</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>destroy all ad slots</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Slot.<span class="hljs-function"><span class="hljs-title">destroy</span> = <span class="hljs-params">()</span>-&gt;</span>
    ad.destroy() <span class="hljs-keyword">for</span> _,ad <span class="hljs-keyword">of</span> slots</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>initialize events with the slot</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Slot.events = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>override default trigger after the mix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  oldTrigger = <span class="hljs-attribute">Slot</span>::trigger
  $sf.lib.lang.mix(<span class="hljs-attribute">Slot</span>::,events)
  <span class="hljs-attribute">Slot</span>::trigger = oldTrigger
  $sf.lib.lang.mix(Slot,events)</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="-slot-creation">   Slot creation</h2>
<p>   The slot gets created by passing a div with various data attributes. That make it behave in different ways.</p>
<table>
<thead>
<tr>
<th>attribute</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>adjs</td>
<td>required, must be set to true in order for the script to know it exists</td>
</tr>
<tr>
<td>ad-type</td>
<td>determines width and height for IAB standard ad units i.e. leaderboard</td>
</tr>
<tr>
<td>width</td>
<td>the ads width instead of using ad-type</td>
</tr>
<tr>
<td>height</td>
<td>the ads height instead of using ad-type</td>
</tr>
<tr>
<td>escaped</td>
<td>if the content is escaped html true,false</td>
</tr>
<tr>
<td>supports</td>
<td>safeframe supported features:  write-cookie,read-cookie, exp-push</td>
</tr>
<tr>
<td>disables</td>
<td>safeframe disabled features: exp-ovr</td>
</tr>
<tr>
<td>inview</td>
<td>only show ad if its inview true,false</td>
</tr>
<tr>
<td>refresh-time</td>
<td>the time in seconds for the ad to be refreshed</td>
</tr>
<tr>
<td>refresh-oov</td>
<td>refresh the ad when out of view after it has been viewed  true,false</td>
</tr>
<tr>
<td>referrer</td>
<td>the visibility of the referrer to the ad (experimental) - all,host,none</td>
</tr>
<tr>
<td>ignore-events</td>
<td>ignore events useful if you want a frame with the adjs domain that you have code you want to talke between them</td>
</tr>
</tbody>
</table>
<p>   Here is an example</p>
<pre><code>     &lt;div data-adjs=<span class="hljs-string">"true"</span> data-width=<span class="hljs-string">"728"</span> data-height=<span class="hljs-string">"90"</span> id=<span class="hljs-string">"unique-id-of-slot"</span> data-refresh-time=<span class="hljs-string">"60"</span> data-inview=<span class="hljs-string">"true"</span>  &gt;
     &lt;!--
       &lt;script src=<span class="hljs-string">"http://example.com/adserver.id.js"</span>/&gt;
     -<span class="hljs-function">-&gt;</span>
     &lt;/div&gt;
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  Slot.<span class="hljs-function"><span class="hljs-title">create</span> = <span class="hljs-params">(d,page)</span>-&gt;</span>
    template = d.innerHTML.match(SCRIPT_REGEX)?[<span class="hljs-number">1</span>] <span class="hljs-keyword">or</span> d.innerHTML
    isEscaped = $sf.lib.lang.cbool(sfDom.attr(d,<span class="hljs-string">"data-escaped"</span>))
    template = $sf.lib.lang.jsunsafe_html(template) <span class="hljs-keyword">if</span> isEscaped
    posId = $sf.lib.lang.guid <span class="hljs-string">"pos"</span>
    adId = d.id <span class="hljs-keyword">or</span> posId
    div = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">"div"</span>
    div.id = posId
    d.appendChild div
    supports = []
    disables = []
    <span class="hljs-keyword">if</span> size = sizes[sfDom.attr(d,<span class="hljs-string">"data-ad-type"</span>)]
      [width,height] = size
    Slot(adId).create div,template,
      <span class="hljs-attribute">width</span>:width <span class="hljs-keyword">or</span> sfDom.attr(d,<span class="hljs-string">"data-width"</span>)
      <span class="hljs-attribute">height</span>:height <span class="hljs-keyword">or</span> sfDom.attr(d,<span class="hljs-string">"data-height"</span>)
      <span class="hljs-attribute">supports</span>: sfDom.attr(d,<span class="hljs-string">"data-supports"</span>).split?(<span class="hljs-string">","</span>)
      <span class="hljs-attribute">disables</span>: sfDom.attr(d,<span class="hljs-string">"data-disables"</span>).split?(<span class="hljs-string">","</span>)
      <span class="hljs-attribute">inview</span>: $sf.lib.lang.cbool(sfDom.attr(d,<span class="hljs-string">"data-inview"</span>))
      <span class="hljs-attribute">refresh_time</span>: sfDom.attr(d,<span class="hljs-string">"data-refresh-time"</span>)
      <span class="hljs-attribute">refresh_oov</span>: $sf.lib.lang.cbool(sfDom.attr(d,<span class="hljs-string">"data-refresh-oov"</span>))
      <span class="hljs-attribute">page</span>: page?.serialize()
      <span class="hljs-attribute">referrer</span>: sfDom.attr(d,<span class="hljs-string">"data-referrer"</span>)
      <span class="hljs-attribute">ignoreEvents</span>:  $sf.lib.lang.cbool(sfDom.attr(d,<span class="hljs-string">"data-ignore-events"</span>))
    Slot(adId)

  Slot.slots = slots
  Slot.sizes = sizes




  Slot</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
