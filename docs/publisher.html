<!DOCTYPE html>

<html>
<head>
  <title>publisher.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="adframe.html">
                adframe.coffee
              </a>
            
              
              <a class="source" href="controller.html">
                controller.coffee
              </a>
            
              
              <a class="source" href="frame.html">
                frame.coffee
              </a>
            
              
              <a class="source" href="publisher.html">
                publisher.coffee
              </a>
            
              
              <a class="source" href="request.html">
                request.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>publisher.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>the publisher script sits in the ad or on the publishers page
this should be renamed, but its the only script an outside party needs to know about</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
inPubframe = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>check to see if safeframe already exists if we aren’t top. Are we in a publisher safeframe?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> <span class="hljs-built_in">window</span>.parent==<span class="hljs-built_in">window</span>.top &amp;&amp; <span class="hljs-built_in">window</span> !=<span class="hljs-built_in">window</span>.top &amp;&amp; <span class="hljs-built_in">window</span>[<span class="hljs-string">"$sf"</span>]
  sf = $sf
  inPubFrame = <span class="hljs-literal">true</span>
<span class="hljs-keyword">else</span>
  sf =  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../node_modules/safeframe/lib/js/host/host'</span>)(<span class="hljs-literal">true</span>) <span class="hljs-keyword">unless</span> <span class="hljs-built_in">window</span>[<span class="hljs-string">"$sf"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><a href="./engagement.html">Engagement</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>engagement = <span class="hljs-built_in">require</span> <span class="hljs-string">'./shared/engagement'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><a href="./page.html">Page</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Page = <span class="hljs-built_in">require</span> <span class="hljs-string">'./shared/page'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><a href="./slot.html">Slot</a> the slot object becomes the base of what is accessible by the external programmer i.e. $ad(“adid”)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>AdJS = <span class="hljs-built_in">require</span> <span class="hljs-string">'./publisher/slot'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><a href="./config.html">Config</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>config = <span class="hljs-built_in">require</span> <span class="hljs-string">'./shared/config'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><a href="./utils.html">Utils</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>utils  =<span class="hljs-built_in">require</span> <span class="hljs-string">'./shared/utils'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><a href="./ad_request.html">AdRequest</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>AdRequest = <span class="hljs-built_in">require</span> <span class="hljs-string">'./shared/ad_request'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><a href="./advertiser.html">Advertiser</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>advertiser = <span class="hljs-built_in">require</span> <span class="hljs-string">'./shared/advertiser'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h1 id="advertiser-code-path">advertiser code path</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(<span class="hljs-built_in">window</span>)</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>initialize session</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sessionObj = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>if</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">window</span> == <span class="hljs-built_in">window</span>.top
    sessionObj = <span class="hljs-keyword">new</span> Page()
  <span class="hljs-keyword">else</span>
    sessionObj = <span class="hljs-keyword">new</span> AdRequest()

  startTicks = utils.now()
  pageLoadMs = <span class="hljs-number">0</span>
  pageDuration = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>all 3 frames have a different url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  safeframeUrl = config.cdn_url
  controllerUrl = config.controller_url
  adframeUrl = config.ad_url
  sfDom =  $sf.lib.dom
  sfDom.attach <span class="hljs-string">"beforeunload"</span>,<span class="hljs-function">-&gt;</span>
    pageDuration =  utils.now()-startTicks
    <span class="hljs-literal">true</span>

  <span class="hljs-function"><span class="hljs-title">doRender</span> = <span class="hljs-params">(cb)</span>-&gt;</span>
    sfPositions  = {}
    <span class="hljs-keyword">if</span> !sfDom.ready()
      sfDom.wait<span class="hljs-function"> -&gt;</span>
        pageLoadMs = (utils.now() - startTicks)
        doRender.apply <span class="hljs-literal">null</span>, args
        args = <span class="hljs-literal">null</span>
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>todo: this should be moved to when the body exists not to when page renders</p>
<ul>
<li>controller is first thing that should exists</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      renderController()
      divs = (div <span class="hljs-keyword">for</span> div <span class="hljs-keyword">in</span> <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">"div"</span>))
      <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> divs <span class="hljs-keyword">when</span> sfDom.attr(d,<span class="hljs-string">"data-adjs"</span>)
        <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(d)</span>-&gt;</span>
          AdJS.create(d,sessionObj)
      cb?()</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>initialize the safeframe configuration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-title">initSafeFrame</span> =  -&gt;</span>
    $sf.host.Config
      <span class="hljs-attribute">renderFile</span>:<span class="hljs-keyword">if</span> <span class="hljs-built_in">window</span> == <span class="hljs-built_in">window</span>.top <span class="hljs-keyword">then</span> safeframeUrl <span class="hljs-keyword">else</span> adframeUrl
      <span class="hljs-attribute">positions</span>:{}
      <span class="hljs-attribute">onStartPosRender</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-attribute">onFailure</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-attribute">onAdLoad</span>: <span class="hljs-function"><span class="hljs-params">(id)</span>-&gt;</span>
        AdJS(id).load()
      <span class="hljs-attribute">onBeforePosMsg</span>: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
      <span class="hljs-attribute">onPosMsg</span>: <span class="hljs-function"><span class="hljs-params">(id,msg,content)</span>-&gt;</span>
        AdJS(id).handleMessage(msg,content)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>creates an invisible safeframe with no events
this is used for all upstream communication and eventually bulk sending of data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-title">renderController</span> = -&gt;</span>
    div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>)
    parent = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>)
    parent.appendChild(div)
    parent.style.display= <span class="hljs-string">"none"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>   div.style.visibility=”hidden”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    div.id= sf.lib.lang.guid <span class="hljs-string">"controller"</span>
    <span class="hljs-built_in">document</span>.body.appendChild(parent)
    AdJS(<span class="hljs-string">"controller"</span>).create div,<span class="hljs-string">''</span>,
      <span class="hljs-attribute">width</span>:<span class="hljs-number">10</span>
      <span class="hljs-attribute">height</span>:<span class="hljs-number">10</span>
      <span class="hljs-attribute">supports</span>:[<span class="hljs-string">"write-cookie"</span>,<span class="hljs-string">"read-cookie"</span>]
      <span class="hljs-attribute">renderFile</span>: controllerUrl
      <span class="hljs-attribute">page</span>: sessionObj.serialize()
      <span class="hljs-attribute">pageReferrer</span>: <span class="hljs-built_in">document</span>.referrer
      <span class="hljs-attribute">ignoreEvents</span>:  <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>renders the ad if we are downstream in the ad creative</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-title">renderAd</span> = -&gt;</span>
    div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>)
    parent = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>)
    parent.appendChild(div)
    parent.style.display= <span class="hljs-string">"none"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>   div.style.visibility=”hidden”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    div.id= sf.lib.lang.guid <span class="hljs-string">"creative"</span>
    <span class="hljs-built_in">document</span>.body.appendChild(parent)
    AdJS(<span class="hljs-string">"creative"</span>).create div,<span class="hljs-string">''</span>,
      <span class="hljs-attribute">width</span>:<span class="hljs-number">10</span>
      <span class="hljs-attribute">height</span>:<span class="hljs-number">10</span>
      <span class="hljs-attribute">renderFile</span>: adframeUrl
      <span class="hljs-attribute">page</span>: sessionObj.serialize()
      <span class="hljs-attribute">pageReferrer</span>: <span class="hljs-built_in">document</span>.referrer
      <span class="hljs-attribute">ignoreEvents</span>:  <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>renders the publishers ad slots or does the creative ad work
iterates through data-adjs divs see description of values in slot</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  AdJS.<span class="hljs-function"><span class="hljs-title">render</span> = <span class="hljs-params">(cb)</span>-&gt;</span>
    adJsScript = (s <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">"script"</span>) <span class="hljs-keyword">when</span> sfDom.attr(s,<span class="hljs-string">"data-adjs"</span>))[<span class="hljs-number">0</span>]
    clientId = sfDom.attr(adJsScript,<span class="hljs-string">"data-client-id"</span>)
    sessionObj.set  <span class="hljs-attribute">client_id</span>:clientId
    initSafeFrame() <span class="hljs-keyword">unless</span> inPubFrame
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">window</span>.top == <span class="hljs-built_in">window</span>
      doRender()
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> inPubFrame
      sessionObj.set(<span class="hljs-attribute">depth_position</span>:<span class="hljs-number">0</span>)
      advertiser.work(sessionObj,<span class="hljs-built_in">window</span>)
    <span class="hljs-keyword">else</span>
      renderAd()</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>session events
handles global engagement</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  engagement.onEngagement<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">for</span> _,ad <span class="hljs-keyword">of</span> AdJS.slots
      <span class="hljs-keyword">if</span> ad.currentlyInview() &amp;&amp; !ad.engaged
        ad.engage()</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>render ad.js ad slots</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">do</span><span class="hljs-function"> -&gt;</span>
    AdJS.render()</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>add module.exports for this…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">window</span>.$ad = AdJS <span class="hljs-keyword">unless</span> inPubframe
  AdJS</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
